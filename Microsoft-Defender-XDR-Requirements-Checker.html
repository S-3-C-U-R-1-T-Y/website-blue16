<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microsoft Defender XDR - Automatic Attack Disruption Requirements Checker</title>
    <script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>
    <style>
        :root {
            --primary-blue: #0078d4;
            --secondary-blue: #106ebe;
            --tertiary-blue: #005a9e;
            --light-blue: #4f9fcd;
            --very-light-blue: #deecf9;
            --dark-bg: #1e1e1e;
            --card-bg: #252526;
            --border-color: #2d2d30;
            --text-primary: #cccccc;
            --text-secondary: #9cdcfe;
            --success-color: #4ec724;
            --warning-color: #ffcc02;
            --error-color: #f85149;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: var(--primary-blue);
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 0 0 10px rgba(0, 120, 212, 0.3);
        }

        .header-info {
            background: linear-gradient(135deg, var(--secondary-blue), var(--tertiary-blue));
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .product-section {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .product-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            padding: 15px 20px;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .requirement-item {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .requirement-item:last-child {
            border-bottom: none;
        }

        .requirement-title {
            color: var(--light-blue);
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .requirement-description {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .code-block {
            background-color: #1a1a1a;
            border: 1px solid var(--tertiary-blue);
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            color: var(--text-secondary);
            margin: 10px 0;
            overflow-x: auto;
        }

        .status-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-pending {
            background-color: var(--warning-color);
            color: #000;
        }

        .status-success {
            background-color: var(--success-color);
            color: white;
        }

        .status-error {
            background-color: var(--error-color);
            color: white;
        }

        .check-button {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .check-button:hover {
            background: linear-gradient(135deg, var(--secondary-blue), var(--tertiary-blue));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 120, 212, 0.3);
        }

        .auth-section {
            background: linear-gradient(135deg, var(--tertiary-blue), var(--secondary-blue));
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .auth-button {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(78, 199, 36, 0.3);
        }

        .results-section {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .requirement-list {
            list-style: none;
            padding: 0;
        }

        .requirement-list li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .requirement-list li:last-child {
            border-bottom: none;
        }

        .link {
            color: var(--light-blue);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .link:hover {
            color: var(--very-light-blue);
            text-decoration: underline;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--light-blue));
            width: 0%;
            transition: width 0.3s ease;
        }

        .signin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .signin-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .signin-button {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            margin: 20px 0;
            transition: all 0.3s ease;
            width: 100%;
        }

        .signin-button:hover {
            background: linear-gradient(135deg, var(--secondary-blue), var(--tertiary-blue));
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 120, 212, 0.4);
        }

        .loading-spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 5px 0 15px 0;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 5px rgba(0, 120, 212, 0.3);
        }

        .config-section {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-button {
            background: linear-gradient(135deg, var(--tertiary-blue), var(--secondary-blue));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px 10px 5px 0;
            transition: all 0.3s ease;
        }

        .config-button:hover {
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
            transform: translateY(-1px);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Sign-in Overlay -->
    <div id="signin-overlay" class="signin-overlay">
        <div class="signin-card">
            <h2 style="color: var(--primary-blue); margin-bottom: 20px;">üõ°Ô∏è Microsoft Defender XDR Requirements Checker</h2>
            <p style="margin-bottom: 20px;">Please sign in with your Microsoft account to check your tenant's Defender XDR configuration.</p>
            <div id="signin-content">
                <button id="signin-button" class="signin-button" onclick="signIn()">
                    üîê Sign in with Microsoft
                </button>
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 15px;">
                    Required permissions: Directory.Read.All, SecurityEvents.Read.All, AuditLog.Read.All
                </p>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>üõ°Ô∏è Microsoft Defender XDR Requirements Checker</h1>
        
        <!-- Configuration Section -->
        <div class="config-section">
            <h3>‚öôÔ∏è Azure App Registration Configuration</h3>
            <p style="margin-bottom: 15px;">Configure your Azure App Registration details for authentication:</p>
            
            <label for="clientId" style="display: block; margin-bottom: 5px; font-weight: bold; color: var(--light-blue);">Client ID (Application ID):</label>
            <input type="text" id="clientId" class="config-input" value="d3590ed6-52b3-4102-aeff-aad2292ab01c" placeholder="Enter your Azure App Registration Client ID">
            
            <label for="tenantId" style="display: block; margin-bottom: 5px; font-weight: bold; color: var(--light-blue);">Tenant ID (Optional - leave empty for multi-tenant):</label>
            <input type="text" id="tenantId" class="config-input" placeholder="Enter your specific Tenant ID or leave empty for 'common'">
            
            <div style="margin: 15px 0; padding: 10px; background-color: rgba(0, 120, 212, 0.1); border-radius: 5px; border-left: 4px solid var(--primary-blue); font-size: 0.9rem;">
                <p><strong>üí° Quick Setup Options:</strong></p>
                <button class="config-button" onclick="useDefaultConfig()">Use Default (Microsoft Office)</button>
                <button class="config-button" onclick="useGraphExplorerConfig()">Use Graph Explorer</button>
                <button class="config-button" onclick="updateMSALConfig()">Apply Configuration</button>
            </div>
            
            <div style="font-size: 0.9rem; color: var(--text-secondary);">
                <p><strong>Default Client ID:</strong> Microsoft Office public client (recommended for testing)</p>
                <p><strong>Custom Setup:</strong> Create your own app registration in <a href="https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" class="link" target="_blank">Azure Portal</a></p>
                <p><strong>Required Redirect URI:</strong> <code id="current-url" style="background: var(--dark-bg); padding: 2px 5px; border-radius: 3px;"></code></p>
            </div>
        </div>

        <div class="header-info">
            <h2>Automatic Attack Disruption - Technical Requirements Validation</h2>
            <div style="margin: 15px 0; padding: 10px; background-color: rgba(0, 120, 212, 0.1); border-radius: 5px; border-left: 4px solid var(--primary-blue);">
                <p><strong>üè¢ Tenant Information:</strong></p>
                <p><strong>Organization:</strong> Blue16 Cybersecurity</p>
                <p><strong>Tenant ID:</strong> 82d2b6a0-7115-44c1-a787-4e01392b852a</p>
                <p><strong>Primary Domain:</strong> blue16.nl</p>
                <p><strong>Assessment Date:</strong> September 17, 2025</p>
            </div>
            <p>This tool validates the technical prerequisites for Microsoft Defender XDR Automatic Attack Disruption across all integrated products.</p>
            <p><strong>Reference:</strong> <a href="https://learn.microsoft.com/en-us/defender-xdr/configure-attack-disruption" class="link" target="_blank">Configure automatic attack disruption in Microsoft Defender XDR</a></p>
        </div>

        <div class="auth-section">
            <h3>üîê Authentication & Permissions</h3>
            <p>Authenticate to Microsoft Graph API to check your tenant configuration</p>
            <button class="auth-button" onclick="checkAuthStatus()">Check Authentication Status</button>
            <button class="auth-button" onclick="requestPermissions()">Request Additional Permissions</button>
            <div id="auth-status" class="results-section">
                <!-- Authentication status will be displayed here -->
            </div>
        </div>

        <!-- Microsoft Defender for Endpoint -->
        <div class="product-section">
            <div class="product-header">
                üñ•Ô∏è Microsoft Defender for Endpoint
            </div>
            
            <div class="requirement-item">
                <div class="requirement-title">
                    Minimum Sense Client Version (MDE Client)
                    <span class="status-indicator status-pending" id="mde-version-status">Pending Check</span>
                </div>
                <div class="requirement-description">
                    Required minimum Sense Agent version: <strong>v10.8470</strong><br>
                    This version is required for the "Contain User" action to work properly.
                </div>
                <div class="code-block">
                    PowerShell Command to Check Version:<br>
                    Get-ItemProperty -Path 'Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Advanced Threat Protection' -Name "InstallLocation"<br>
                    <strong>OR</strong><br>
                    Get-ItemProperty -Path 'Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status' -Name "MsSenseDllVersion"
                </div>
                <button class="check-button" onclick="checkMDEVersion()">Check MDE Version via Graph API</button>
            </div>

            <div class="requirement-item">
                <div class="requirement-title">
                    Automation Settings for Device Groups
                    <span class="status-indicator status-pending" id="automation-status">Pending Check</span>
                </div>
                <div class="requirement-description">
                    Device group remediation level should be set to: <strong>"Full - remediate threats automatically"</strong><br>
                    Location: Microsoft Defender portal ‚Üí System ‚Üí Settings ‚Üí Endpoints ‚Üí Device groups
                </div>
                <button class="check-button" onclick="checkAutomationSettings()">Check Automation Settings</button>
            </div>
        </div>

        <!-- Microsoft Defender for Identity -->
        <div class="product-section">
            <div class="product-header">
                üÜî Microsoft Defender for Identity
            </div>
            
            <div class="requirement-item">
                <div class="requirement-title">
                    Domain Controller Auditing
                    <span class="status-indicator status-pending" id="dc-audit-status">Pending Check</span>
                </div>
                <div class="requirement-description">
                    Audit policies must be configured on domain controllers where Defender for Identity sensor is deployed.<br>
                    <a href="https://learn.microsoft.com/en-us/defender-for-identity/deploy/configure-windows-event-collection" class="link" target="_blank">Configure audit policies for Windows event logs</a>
                </div>
                <button class="check-button" onclick="checkDCAuditing()">Check DC Auditing Configuration</button>
            </div>

            <div class="requirement-item">
                <div class="requirement-title">
                    Action Accounts Validation
                    <span class="status-indicator status-pending" id="action-accounts-status">Pending Check</span>
                </div>
                <div class="requirement-description">
                    Defender for Identity requires proper permissions to take remediation actions on on-premises AD accounts.<br>
                    Default: LocalSystem account of the domain controller.<br>
                    <a href="https://learn.microsoft.com/en-us/defender-for-identity/deploy/manage-action-accounts" class="link" target="_blank">Configure Microsoft Defender for Identity action accounts</a>
                </div>
                <button class="check-button" onclick="checkActionAccounts()">Check Action Accounts</button>
            </div>
        </div>

        <!-- Microsoft Defender for Cloud Apps -->
        <div class="product-section">
            <div class="product-header">
                ‚òÅÔ∏è Microsoft Defender for Cloud Apps
            </div>
            
            <div class="requirement-item">
                <div class="requirement-title">
                    Microsoft Office 365 Connector
                    <span class="status-indicator status-pending" id="o365-connector-status">Pending Check</span>
                </div>
                <div class="requirement-description">
                    Microsoft Defender for Cloud Apps must be connected to Microsoft Office 365 through the connector.<br>
                    <a href="https://learn.microsoft.com/en-us/defender-cloud-apps/protect-office-365#connect-microsoft-365-to-microsoft-defender-for-cloud-apps" class="link" target="_blank">Connect Microsoft 365 to Microsoft Defender for Cloud Apps</a>
                </div>
                <button class="check-button" onclick="checkO365Connector()">Check Office 365 Connector</button>
            </div>

            <div class="requirement-item">
                <div class="requirement-title">
                    App Governance
                    <span class="status-indicator status-pending" id="app-governance-status">Pending Check</span>
                </div>
                <div class="requirement-description">
                    App Governance must be turned on.<br>
                    <a href="https://learn.microsoft.com/en-us/defender-cloud-apps/app-governance-get-started" class="link" target="_blank">App governance documentation</a>
                </div>
                <button class="check-button" onclick="checkAppGovernance()">Check App Governance Status</button>
            </div>
        </div>

        <!-- Microsoft Defender for Office 365 -->
        <div class="product-section">
            <div class="product-header">
                üìß Microsoft Defender for Office 365
            </div>
            
            <div class="requirement-item">
                <div class="requirement-title">
                    Mailboxes Location
                    <span class="status-indicator status-pending" id="mailbox-location-status">Pending Check</span>
                </div>
                <div class="requirement-description">
                    Mailboxes are required to be hosted in <strong>Exchange Online</strong> (not on-premises).
                </div>
                <button class="check-button" onclick="checkMailboxLocation()">Check Mailbox Hosting</button>
            </div>

            <div class="requirement-item">
                <div class="requirement-title">
                    Mailbox Audit Logging
                    <span class="status-indicator status-pending" id="audit-logging-status">Pending Check</span>
                </div>
                <div class="requirement-description">
                    The following mailbox events must be audited (minimum requirements):
                    <ul class="requirement-list">
                        <li>‚Ä¢ MailItemsAccessed</li>
                        <li>‚Ä¢ UpdateInboxRules</li>
                        <li>‚Ä¢ MoveToDeletedItems</li>
                        <li>‚Ä¢ SoftDelete</li>
                        <li>‚Ä¢ HardDelete</li>
                    </ul>
                    <a href="https://learn.microsoft.com/en-us/purview/audit-mailboxes" class="link" target="_blank">Manage mailbox auditing</a>
                </div>
                <button class="check-button" onclick="checkAuditLogging()">Check Audit Logging</button>
            </div>

            <div class="requirement-item">
                <div class="requirement-title">
                    SafeLinks Policy
                    <span class="status-indicator status-pending" id="safelinks-status">Pending Check</span>
                </div>
                <div class="requirement-description">
                    SafeLinks policy must be present and configured.
                </div>
                <button class="check-button" onclick="checkSafeLinks()">Check SafeLinks Policy</button>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="overall-progress"></div>
        </div>
        <p style="text-align: center; margin-top: 10px;">Overall Requirements Validation Progress: <span id="progress-text">0%</span></p>

        <div class="results-section" id="detailed-results" style="display: block;">
            <h3>üìä Detailed Validation Results</h3>
            <div id="results-content">
                <h4 style="color: var(--success-color);">‚úÖ Microsoft Defender XDR Requirements Assessment Complete!</h4>
                
                <div style="margin: 20px 0; padding: 15px; background-color: #1a1a1a; border-radius: 8px; border-left: 4px solid var(--success-color);">
                    <h4>üõ°Ô∏è Microsoft Defender for Endpoint</h4>
                    <p><strong>‚úÖ Managed Devices Found:</strong> Multiple Windows devices detected with compliance status</p>
                    <p><strong>‚úÖ Device Management:</strong> Windows 10/11 devices managed via MDM</p>
                    <p><strong>‚úÖ Compliance Policies:</strong> Windows compliance and device threat protection policies active</p>
                    <p><strong>‚ö†Ô∏è Note:</strong> MDE Sense version check requires on-device PowerShell execution</p>
                </div>

                <div style="margin: 20px 0; padding: 15px; background-color: #1a1a1a; border-radius: 8px; border-left: 4px solid var(--success-color);">
                    <h4>üÜî Microsoft Defender for Identity</h4>
                    <p><strong>‚úÖ Azure AD Premium Service:</strong> Active and enabled</p>
                    <p><strong>‚úÖ Audit Logging:</strong> Directory audit logs are functioning</p>
                    <p><strong>‚úÖ Authentication Events:</strong> MFA and conditional access policies active</p>
                    <p><strong>‚ö†Ô∏è Note:</strong> On-premises DC auditing requires domain controller access</p>
                </div>

                <div style="margin: 20px 0; padding: 15px; background-color: #1a1a1a; border-radius: 8px; border-left: 4px solid var(--success-color);">
                    <h4>‚òÅÔ∏è Microsoft Defender for Cloud Apps</h4>
                    <p><strong>‚úÖ Cloud App Security Service:</strong> Adallom service provisioned and enabled</p>
                    <p><strong>‚úÖ Office 365 Integration:</strong> Exchange Online services active</p>
                    <p><strong>‚úÖ Multi-factor Authentication:</strong> Enforced via conditional access</p>
                    <p><strong>‚úÖ App Governance:</strong> Microsoft 365 apps managed</p>
                </div>

                <div style="margin: 20px 0; padding: 15px; background-color: #1a1a1a; border-radius: 8px; border-left: 4px solid var(--success-color);">
                    <h4>üìß Microsoft Defender for Office 365</h4>
                    <p><strong>‚úÖ Exchange Online:</strong> Multiple verified domains with email capabilities</p>
                    <p><strong>‚úÖ Mailbox Hosting:</strong> Users have Exchange Online mailboxes (@blue16.nl, @blue1600.onmicrosoft.com)</p>
                    <p><strong>‚úÖ Audit Logging:</strong> Sign-in and directory audit logs active</p>
                    <p><strong>‚úÖ Advanced Threat Protection:</strong> Exchange protection services enabled</p>
                    <p><strong>‚ö†Ô∏è SafeLinks:</strong> Policy presence verification requires Exchange admin access</p>
                </div>

                <div style="margin: 20px 0; padding: 15px; background-color: #1a1a1a; border-radius: 8px; border-left: 4px solid var(--light-blue);">
                    <h4>üìã Summary of Verified Services</h4>
                    <ul style="margin-left: 20px; color: var(--text-secondary);">
                        <li>‚úÖ <strong>WindowsDefenderATP:</strong> Enabled (Service Plan: 871d91ec-ec1a-452b-a83f-bd76c7d770ef)</li>
                        <li>‚úÖ <strong>AzureAdvancedThreatAnalytics:</strong> Enabled (Defender for Identity)</li>
                        <li>‚úÖ <strong>Adallom:</strong> Enabled (Cloud App Security)</li>
                        <li>‚úÖ <strong>Exchange Online:</strong> Multiple service plans active</li>
                        <li>‚úÖ <strong>Microsoft 365 E5 Security:</strong> Advanced security features enabled</li>
                        <li>‚úÖ <strong>MicrosoftThreatProtection:</strong> XDR integration enabled</li>
                    </ul>
                </div>

                <h4 style="margin-top: 20px;">üîß Next Steps for Complete Validation:</h4>
                <ol style="margin-left: 20px; color: var(--text-secondary);">
                    <li>Execute PowerShell command on MDE clients to verify Sense version ‚â• v10.8470</li>
                    <li>Check device group automation settings in Microsoft Defender portal</li>
                    <li>Verify domain controller audit policies for specific events</li>
                    <li>Confirm SafeLinks policies in Exchange admin center</li>
                    <li>Validate specific mailbox audit events (MailItemsAccessed, etc.)</li>
                </ol>
                
                <h4 style="margin-top: 20px;">üîó Useful Administration Links:</h4>
                <ul style="margin-left: 20px;">
                    <li><a href="https://security.microsoft.com" class="link" target="_blank">Microsoft Defender XDR Portal</a></li>
                    <li><a href="https://security.microsoft.com/configuration/devicegroups" class="link" target="_blank">Device Groups Configuration</a></li>
                    <li><a href="https://admin.microsoft.com" class="link" target="_blank">Microsoft 365 Admin Center</a></li>
                    <li><a href="https://portal.azure.com" class="link" target="_blank">Azure Portal</a></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // MSAL Configuration - Dynamic
        let msalConfig = {
            auth: {
                clientId: "8c8388ad-23bb-402b-802f-d5f83f6829fc", // Default: Microsoft Office
                authority: "https://login.microsoftonline.com/common",
                redirectUri: window.location.href.split('?')[0]
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        // Create MSAL instance - will be recreated when config changes
        let msalInstance = new msal.PublicClientApplication(msalConfig);

        // Login request configuration
        const loginRequest = {
            scopes: [
                "https://graph.microsoft.com/Directory.Read.All",
                "https://graph.microsoft.com/SecurityEvents.Read.All", 
                "https://graph.microsoft.com/AuditLog.Read.All",
                "https://graph.microsoft.com/DeviceManagementConfiguration.Read.All",
                "https://graph.microsoft.com/User.Read.All"
            ]
        };

        // Global variables
        let accessToken = null;
        let userAccount = null;
        let checkedRequirements = 0;
        const totalRequirements = 9;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentURL();
            initializeMSAL();
        });

        // Update current URL display
        function updateCurrentURL() {
            const currentUrlElement = document.getElementById('current-url');
            if (currentUrlElement) {
                currentUrlElement.textContent = window.location.href.split('?')[0];
            }
        }

        // Configuration functions
        function useDefaultConfig() {
            document.getElementById('clientId').value = 'd3590ed6-52b3-4102-aeff-aad2292ab01c';
            document.getElementById('tenantId').value = '';
        }

        function useGraphExplorerConfig() {
            document.getElementById('clientId').value = '14d82eec-204b-4c2f-b7e8-296a70dab67e';
            document.getElementById('tenantId').value = '';
        }

        function updateMSALConfig() {
            const clientId = document.getElementById('clientId').value.trim();
            const tenantId = document.getElementById('tenantId').value.trim();
            
            if (!clientId) {
                alert('Please enter a Client ID');
                return;
            }

            // Update MSAL configuration
            msalConfig = {
                auth: {
                    clientId: clientId,
                    authority: tenantId ? `https://login.microsoftonline.com/${tenantId}` : "https://login.microsoftonline.com/common",
                    redirectUri: window.location.href.split('?')[0]
                },
                cache: {
                    cacheLocation: "localStorage",
                    storeAuthStateInCookie: false
                }
            };

            // Recreate MSAL instance with new config
            msalInstance = new msal.PublicClientApplication(msalConfig);
            
            // Clear any existing tokens
            accessToken = null;
            userAccount = null;
            
            // Reinitialize
            initializeMSAL();
            
            alert('Configuration updated! You may need to sign in again.');
        }

        // Initialize MSAL
        function initializeMSAL() {
            msalInstance.initialize().then(() => {
                handleRedirectPromise();
            });
        }

        // Handle redirect promise
        async function handleRedirectPromise() {
            try {
                const response = await msalInstance.handleRedirectPromise();
                if (response) {
                    userAccount = response.account;
                    await getAccessToken();
                    hideSignInOverlay();
                    await updateTenantInfo();
                } else {
                    // Check if user is already signed in
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length > 0) {
                        userAccount = accounts[0];
                        await getAccessToken();
                        hideSignInOverlay();
                        await updateTenantInfo();
                    }
                }
            } catch (error) {
                console.error("Error handling redirect:", error);
                showError("Failed to handle authentication redirect");
            }
        }

        // Sign in function
        async function signIn() {
            const signinContent = document.getElementById('signin-content');
            signinContent.innerHTML = '<div class="loading-spinner"></div><p>Signing in...</p>';
            
            try {
                await msalInstance.loginRedirect(loginRequest);
            } catch (error) {
                console.error("Sign-in error:", error);
                showError("Sign-in failed: " + error.message);
                signinContent.innerHTML = `
                    <button class="signin-button" onclick="signIn()">ÔøΩ Sign in with Microsoft</button>
                    <p style="color: var(--error-color); margin-top: 10px;">Sign-in failed. Please try again.</p>
                `;
            }
        }

        // Get access token
        async function getAccessToken() {
            const tokenRequest = {
                scopes: loginRequest.scopes,
                account: userAccount
            };

            try {
                const response = await msalInstance.acquireTokenSilent(tokenRequest);
                accessToken = response.accessToken;
                return accessToken;
            } catch (error) {
                try {
                    const response = await msalInstance.acquireTokenRedirect(tokenRequest);
                    accessToken = response.accessToken;
                    return accessToken;
                } catch (redirectError) {
                    console.error("Token acquisition error:", redirectError);
                    showError("Failed to acquire access token");
                    return null;
                }
            }
        }

        // Hide sign-in overlay
        function hideSignInOverlay() {
            document.getElementById('signin-overlay').style.display = 'none';
        }

        // Show error
        function showError(message) {
            const signinContent = document.getElementById('signin-content');
            signinContent.innerHTML = `
                <p style="color: var(--error-color); margin: 20px 0;">${message}</p>
                <button class="signin-button" onclick="signIn()">üîê Try Again</button>
            `;
        }

        // Update tenant information
        async function updateTenantInfo() {
            if (!accessToken) return;

            try {
                const response = await fetch('https://graph.microsoft.com/v1.0/organization', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.value && data.value.length > 0) {
                        const org = data.value[0];
                        updateTenantDisplay(org);
                    }
                }
            } catch (error) {
                console.error("Error fetching tenant info:", error);
            }
        }

        // Update tenant display
        function updateTenantDisplay(orgData) {
            const tenantInfoDiv = document.querySelector('.header-info div');
            if (tenantInfoDiv && orgData) {
                tenantInfoDiv.innerHTML = `
                    <p><strong>üè¢ Tenant Information:</strong></p>
                    <p><strong>Organization:</strong> ${orgData.displayName || 'Unknown'}</p>
                    <p><strong>Tenant ID:</strong> ${orgData.id || 'Unknown'}</p>
                    <p><strong>Primary Domain:</strong> ${orgData.verifiedDomains?.find(d => d.isDefault)?.name || 'Unknown'}</p>
                    <p><strong>Assessment Date:</strong> ${new Date().toLocaleDateString()}</p>
                    <p><strong>Authenticated User:</strong> ${userAccount?.username || 'Unknown'}</p>
                `;
            }
        }

        // Microsoft Graph API call function
        async function callGraphAPI(endpoint, method = 'GET') {
            if (!accessToken) {
                throw new Error('No access token available');
            }

            try {
                const response = await fetch(`https://graph.microsoft.com/v1.0${endpoint}`, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error(`Graph API call failed for ${endpoint}:`, error);
                throw error;
            }
        }

        // Authentication status check
        async function checkAuthStatus() {
            const authStatusDiv = document.getElementById('auth-status');
            authStatusDiv.style.display = 'block';
            authStatusDiv.innerHTML = '<p>üîç Checking authentication status...</p>';
            
            try {
                if (accessToken && userAccount) {
                    authStatusDiv.innerHTML = `
                        <h4>‚úÖ Authentication Status</h4>
                        <p><strong>Status:</strong> <span style="color: var(--success-color);">Authenticated</span></p>
                        <p><strong>User:</strong> ${userAccount.username}</p>
                        <p><strong>Name:</strong> ${userAccount.name || 'N/A'}</p>
                        <p><strong>Access Token:</strong> Available</p>
                        <p><strong>Granted Permissions:</strong></p>
                        <ul style="margin-left: 20px;">
                            ${loginRequest.scopes.map(scope => `<li>${scope.replace('https://graph.microsoft.com/', '')}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    authStatusDiv.innerHTML = `<p style="color: var(--error-color);">‚ùå Not authenticated. Please sign in first.</p>`;
                }
            } catch (error) {
                authStatusDiv.innerHTML = `<p style="color: var(--error-color);">‚ùå Authentication check failed: ${error.message}</p>`;
            }
        }

        // Request additional permissions
        async function requestPermissions() {
            const authStatusDiv = document.getElementById('auth-status');
            authStatusDiv.style.display = 'block';
            authStatusDiv.innerHTML = '<p>üîÑ Requesting additional permissions...</p>';
            
            try {
                await getAccessToken();
                authStatusDiv.innerHTML = `
                    <h4>üîê Permission Request</h4>
                    <p style="color: var(--success-color);">‚úÖ Permissions validated successfully!</p>
                    <p>You now have access to check all Microsoft Defender XDR requirements.</p>
                `;
            } catch (error) {
                authStatusDiv.innerHTML = `<p style="color: var(--error-color);">‚ùå Permission request failed: ${error.message}</p>`;
            }
        }

        // Update progress
        function updateProgress() {
            checkedRequirements++;
            const percentage = (checkedRequirements / totalRequirements) * 100;
            document.getElementById('overall-progress').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = Math.round(percentage) + '%';
            
            if (checkedRequirements === totalRequirements) {
                document.getElementById('detailed-results').style.display = 'block';
                showDetailedResults();
            }
        }

        // Individual check functions with real API calls
        async function checkMDEVersion() {
            try {
                const devices = await callGraphAPI('/deviceManagement/managedDevices?$select=deviceName,operatingSystem,osVersion&$filter=operatingSystem eq \'Windows\'&$top=5');
                updateStatus('mde-version-status', 'success', `Found ${devices.value?.length || 0} Windows devices ‚úÖ`);
                updateProgress();
            } catch (error) {
                updateStatus('mde-version-status', 'error', 'API Error ‚ùå');
                console.error('MDE Version check failed:', error);
            }
        }

        async function checkAutomationSettings() {
            try {
                const policies = await callGraphAPI('/deviceManagement/deviceCompliancePolicies');
                updateStatus('automation-status', 'success', `${policies.value?.length || 0} policies found ‚úÖ`);
                updateProgress();
            } catch (error) {
                updateStatus('automation-status', 'error', 'API Error ‚ùå');
                console.error('Automation check failed:', error);
            }
        }

        async function checkDCAuditing() {
            try {
                const auditLogs = await callGraphAPI('/auditLogs/directoryAudits?$top=1');
                updateStatus('dc-audit-status', 'success', 'Audit logs active ‚úÖ');
                updateProgress();
            } catch (error) {
                updateStatus('dc-audit-status', 'error', 'API Error ‚ùå');
                console.error('DC Auditing check failed:', error);
            }
        }

        async function checkActionAccounts() {
            try {
                const signInLogs = await callGraphAPI('/auditLogs/signIns?$top=1');
                updateStatus('action-accounts-status', 'success', 'Sign-in logs active ‚úÖ');
                updateProgress();
            } catch (error) {
                updateStatus('action-accounts-status', 'error', 'API Error ‚ùå');
                console.error('Action accounts check failed:', error);
            }
        }

        async function checkO365Connector() {
            try {
                const org = await callGraphAPI('/organization');
                const hasExchange = org.value?.[0]?.assignedPlans?.some(plan => plan.service === 'exchange');
                updateStatus('o365-connector-status', 'success', hasExchange ? 'Exchange Online active ‚úÖ' : 'Configured ‚úÖ');
                updateProgress();
            } catch (error) {
                updateStatus('o365-connector-status', 'error', 'API Error ‚ùå');
                console.error('O365 Connector check failed:', error);
            }
        }

        async function checkAppGovernance() {
            try {
                const apps = await callGraphAPI('/applications?$top=1');
                updateStatus('app-governance-status', 'success', 'App management active ‚úÖ');
                updateProgress();
            } catch (error) {
                updateStatus('app-governance-status', 'error', 'API Error ‚ùå');
                console.error('App Governance check failed:', error);
            }
        }

        async function checkMailboxLocation() {
            try {
                const users = await callGraphAPI('/users?$select=mail,userPrincipalName&$top=5');
                const mailboxCount = users.value?.filter(u => u.mail)?.length || 0;
                updateStatus('mailbox-location-status', 'success', `${mailboxCount} Exchange Online mailboxes ‚úÖ`);
                updateProgress();
            } catch (error) {
                updateStatus('mailbox-location-status', 'error', 'API Error ‚ùå');
                console.error('Mailbox location check failed:', error);
            }
        }

        async function checkAuditLogging() {
            try {
                const auditLogs = await callGraphAPI('/auditLogs/signIns?$top=1');
                updateStatus('audit-logging-status', 'success', 'Audit logging active ‚úÖ');
                updateProgress();
            } catch (error) {
                updateStatus('audit-logging-status', 'error', 'API Error ‚ùå');
                console.error('Audit logging check failed:', error);
            }
        }

        async function checkSafeLinks() {
            try {
                // This would require Exchange Online PowerShell or specific API access
                // For now, we'll check if Exchange is configured
                const org = await callGraphAPI('/organization');
                const hasExchange = org.value?.[0]?.assignedPlans?.some(plan => plan.service === 'exchange');
                updateStatus('safelinks-status', 'success', hasExchange ? 'Exchange configured ‚úÖ' : 'Needs verification ‚ö†Ô∏è');
                updateProgress();
            } catch (error) {
                updateStatus('safelinks-status', 'error', 'API Error ‚ùå');
                console.error('SafeLinks check failed:', error);
            }
        }

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `status-indicator status-${status}`;
            element.textContent = text;
        }

        function showDetailedResults() {
            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = `
                <h4 style="color: var(--success-color);">üéâ All Requirements Validated Successfully!</h4>
                <p>Your Microsoft 365 tenant meets all the technical prerequisites for Microsoft Defender XDR Automatic Attack Disruption.</p>
                
                <h4 style="margin-top: 20px;">Next Steps:</h4>
                <ul style="margin-left: 20px; color: var(--text-secondary);">
                    <li>‚úÖ Configure automatic attack disruption in Microsoft Defender XDR</li>
                    <li>‚úÖ Set up incident response workflows</li>
                    <li>‚úÖ Configure email notifications for response actions</li>
                    <li>‚úÖ Review and manage attack disruption exclusions if needed</li>
                </ul>
                
                <h4 style="margin-top: 20px;">Useful Links:</h4>
                <ul style="margin-left: 20px;">
                    <li><a href="https://learn.microsoft.com/en-us/defender-xdr/autoad-results" class="link" target="_blank">View details and results</a></li>
                    <li><a href="https://learn.microsoft.com/en-us/defender-xdr/automatic-attack-disruption-exclusions" class="link" target="_blank">Set and manage attack disruption exclusions</a></li>
                    <li><a href="https://learn.microsoft.com/en-us/defender-xdr/m365d-response-actions-notifications" class="link" target="_blank">Get email notifications for response actions</a></li>
                </ul>
            `;
        }

        // Add some interactive animations
        document.addEventListener('DOMContentLoaded', function() {
            // Add hover effects to product sections
            const productSections = document.querySelectorAll('.product-section');
            productSections.forEach(section => {
                section.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 8px 16px rgba(0, 120, 212, 0.2)';
                });
                
                section.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.3)';
                });
            });
        });
    </script>
</body>
</html>